(window.webpackJsonp=window.webpackJsonp||[]).push([[80],{384:function(t,e,a){"use strict";a.r(e);var s=a(0),n=Object(s.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"activity-and-workflow-retries"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#activity-and-workflow-retries"}},[t._v("#")]),t._v(" Activity and workflow retries")]),t._v(" "),e("p",[e("Term",{attrs:{term:"activity",show:"Activities"}}),t._v(" and "),e("Term",{attrs:{term:"workflow",show:"workflows"}}),t._v(" can fail due to various intermediate conditions. In those cases, we want\nto retry the failed "),e("Term",{attrs:{term:"activity"}}),t._v(" or child "),e("Term",{attrs:{term:"workflow"}}),t._v(" or even the parent "),e("Term",{attrs:{term:"workflow"}}),t._v(". This can be achieved\nby supplying an optional retry policy. A retry policy looks like the following:")],1),t._v(" "),e("div",{staticClass:"language-go extra-class"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// RetryPolicy defines the retry policy.")]),t._v("\nRetryPolicy "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Backoff interval for the first retry. If coefficient is 1.0 then it is used for all retries.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Required, no default value.")]),t._v("\n    InitialInterval time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Duration\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Coefficient used to calculate the next retry backoff interval.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The next retry interval is previous interval multiplied by this coefficient.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Must be 1 or larger. Default is 2.0.")]),t._v("\n    BackoffCoefficient "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("float64")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Maximum backoff interval between retries. Exponential backoff leads to interval increase.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// This value is the cap of the interval. Default is 100x of initial interval.")]),t._v("\n    MaximumInterval time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Duration\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Maximum time to retry. Either ExpirationInterval or MaximumAttempts is required.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// When exceeded the retries stop even if maximum retries is not reached yet.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// First (non-retry) attempt is unaffected by this field and is guaranteed to run ")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// for the entirety of the workflow timeout duration (ExecutionStartToCloseTimeoutSeconds).")]),t._v("\n    ExpirationInterval time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Duration\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Maximum number of attempts. When exceeded the retries stop even if not expired yet.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// If not set or set to 0, it means unlimited, and relies on ExpirationInterval to stop.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Either MaximumAttempts or ExpirationInterval is required.")]),t._v("\n    MaximumAttempts "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int32")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Non-Retriable errors. This is optional. Cadence server will stop retry if error reason matches this list.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Error reason for custom error is specified when your activity/workflow returns cadence.NewCustomError(reason).")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// Error reason for panic error is "cadenceInternal:Panic".')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// Error reason for any other error is "cadenceInternal:Generic".')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// Error reason for timeouts is: "cadenceInternal:Timeout TIMEOUT_TYPE". TIMEOUT_TYPE could be START_TO_CLOSE or HEARTBEAT.')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Note that cancellation is not a failure, so it won't be retried.")]),t._v("\n    NonRetriableErrorReasons "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("To enable retry, supply a custom retry policy to "),e("code",[t._v("ActivityOptions")]),t._v(" or "),e("code",[t._v("ChildWorkflowOptions")]),t._v("\nwhen you execute them.")]),t._v(" "),e("div",{staticClass:"language-go extra-class"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[t._v("expiration "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Minute "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\nretryPolicy "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("cadence"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RetryPolicy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    InitialInterval"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("    time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Second"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    BackoffCoefficient"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    MaximumInterval"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("    expiration"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    ExpirationInterval"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Minute "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    MaximumAttempts"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("    "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nao "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" workflow"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ActivityOptions"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ScheduleToStartTimeout"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" expiration"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    StartToCloseTimeout"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("    expiration"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    HeartbeatTimeout"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("       time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Second "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    RetryPolicy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("            retryPolicy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Enable retry.")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nctx "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" workflow"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("WithActivityOptions")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ao"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nactivityFuture "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" workflow"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ExecuteActivity")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SampleActivity"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" params"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("p",[t._v("If "),e("Term",{attrs:{term:"activity"}}),t._v(" heartbeat its progress before it failed, the retry attempt will contain the progress\nso "),e("Term",{attrs:{term:"activity"}}),t._v(" implementation could resume from failed progress like:")],1),t._v(" "),e("div",{staticClass:"language-go extra-class"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("SampleActivity")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx context"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Context"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" inputArg InputParams"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    startIdx "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" inputArg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StartIndex\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" activity"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("HasHeartbeatDetails")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Recover from finished progress.")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" finishedIndex "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" activity"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("GetHeartbeatDetails")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("finishedIndex"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            startIdx "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" finishedIndex "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Start from next one.")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Normal activity logic...")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v("startIdx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("inputArg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EndIdx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Code for processing item i goes here...")]),t._v("\n        activity"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("RecordHeartbeat")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" i"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Report progress.")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("Like retry for an "),e("Term",{attrs:{term:"activity"}}),t._v(", you need to supply a retry policy for "),e("code",[t._v("ChildWorkflowOptions")]),t._v(" to enable\nretry for a child "),e("Term",{attrs:{term:"workflow"}}),t._v(". To enable retry for a parent "),e("Term",{attrs:{term:"workflow"}}),t._v(", supply a retry policy when\nyou start a "),e("Term",{attrs:{term:"workflow"}}),t._v(" via "),e("code",[t._v("StartWorkflowOptions")]),t._v(".")],1),t._v(" "),e("p",[t._v("There are some subtle changes to "),e("Term",{attrs:{term:"workflow"}}),t._v("'s history "),e("Term",{attrs:{term:"event",show:"events"}}),t._v(" when "),e("code",[t._v("RetryPolicy")]),t._v(" is used.\nFor an "),e("Term",{attrs:{term:"activity"}}),t._v(" with "),e("code",[t._v("RetryPolicy")]),t._v(":")],1),t._v(" "),e("ul",[e("li",[t._v("The "),e("code",[t._v("ActivityTaskScheduledEvent")]),t._v(" will have extended "),e("code",[t._v("ScheduleToStartTimeout")]),t._v(" and "),e("code",[t._v("ScheduleToCloseTimeout")]),t._v(". These two timeouts\nwill be overwritten by the server to be as long as the retry policy's "),e("code",[t._v("ExpirationInterval")]),t._v(". If the "),e("code",[t._v("ExpirationInterval")]),t._v("\nis not specified, it will be overwritten to the "),e("Term",{attrs:{term:"workflow"}}),t._v("'s timeout.")],1),t._v(" "),e("li",[t._v("The "),e("code",[t._v("ActivityTaskStartedEvent")]),t._v(" will not show up in history until the "),e("Term",{attrs:{term:"activity"}}),t._v(" is completed or failed with no more retry.\nThis is to avoid recording the "),e("code",[t._v("ActivityTaskStarted")]),t._v(" "),e("Term",{attrs:{term:"event"}}),t._v(" but later it failed and retried. Using the "),e("code",[t._v("DescribeWorkflowExecution")]),t._v("\nAPI will return the "),e("code",[t._v("PendingActivityInfo")]),t._v(" and it will contain "),e("code",[t._v("attemptCount")]),t._v(" if it is retrying.")],1)]),t._v(" "),e("p",[t._v("For a "),e("Term",{attrs:{term:"workflow"}}),t._v(" with "),e("code",[t._v("RetryPolicy")]),t._v(":")],1),t._v(" "),e("ul",[e("li",[t._v("If a "),e("Term",{attrs:{term:"workflow"}}),t._v(" failed and needs to retry, the "),e("Term",{attrs:{term:"workflow_execution"}}),t._v(" will be closed with a "),e("code",[t._v("ContinueAsNew")]),t._v(" "),e("Term",{attrs:{term:"event"}}),t._v(". The "),e("Term",{attrs:{term:"event"}}),t._v("\nwill have the "),e("code",[t._v("ContinueAsNewInitiator")]),t._v(" set to "),e("code",[t._v("RetryPolicy")]),t._v(" and the new "),e("code",[t._v("RunID")]),t._v(" for the next retry attempt.")],1),t._v(" "),e("li",[t._v("The new attempt will be created immediately. But the first "),e("Term",{attrs:{term:"decision_task"}}),t._v(" won't be scheduled until the backoff duration\nwhich is also recorded in the new run's "),e("code",[t._v("WorkflowExecutionStartedEventAttributes")]),t._v(" "),e("Term",{attrs:{term:"event"}}),t._v(" as "),e("code",[t._v("firstDecisionTaskBackoffSeconds")]),t._v(".")],1)])])}),[],!1,null,null,null);e.default=n.exports}}]);